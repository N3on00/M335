# SpotOnSight API Specification (Current + Hardening Target)

## 1) Scope and Source of Truth

- Runtime backend includes:
  - decorator-registered CRUD routers
  - auth/social routers
  - Evidence: `backend/routing/routing.py:27`, `backend/routing/routing.py:29`
- DTO definitions are split across:
  - `backend/routing/auth_routes.py` (auth/social/support)
  - `backend/data/dto.py` (generic entities)

## 2) Endpoint Inventory

## 2.1 Generic CRUD Endpoints (Decorator-driven)

Routes generated by `router_create`:

- `POST /{prefix}/`
- `GET /{prefix}/`
- `GET /{prefix}/{entity_id}`
- `PUT /{prefix}/{entity_id}`
- `DELETE /{prefix}/{entity_id}`

Evidence: `backend/routing/router.py:83`, `backend/routing/router.py:96`, `backend/routing/router.py:107`, `backend/routing/router.py:125`, `backend/routing/router.py:144`

Currently registered prefixes:

- `/spots` via `Spot`
- `/client-errors` via `ClientErrorReport`

Evidence: `backend/data/dto.py:11`, `backend/data/dto.py:31`

## 2.2 Auth and Social Endpoints

| Method | Path | Purpose | Request DTO | Response DTO |
|---|---|---|---|---|
| POST | `/auth/register` | Register user + issue token | `RegisterRequest` | `AuthTokenResponse` |
| POST | `/auth/login` | Login with username/email | OAuth form | `AuthTokenResponse` |
| GET | `/social/me` | Get current user profile | - | `UserPublic` |
| PUT | `/social/me` | Update profile/settings | `UpdateProfileRequest` | `UserPublic` |
| GET | `/social/users/search` | Search users | query params | `List[UserPublic]` |
| GET | `/social/users/{user_id}/profile` | Get user profile by id | - | `UserPublic` |
| GET | `/social/spots` | List visible spots | - | `List[SpotPublic]` |
| POST | `/social/spots` | Create spot | `SpotUpsertRequest` | `SpotPublic` |
| PUT | `/social/spots/{spot_id}` | Update spot | `SpotUpsertRequest` | `SpotPublic` |
| DELETE | `/social/spots/{spot_id}` | Delete spot | - | `{ok: true}` |
| GET | `/social/users/{user_id}/spots` | List user's spots | - | `List[SpotPublic]` |
| POST | `/social/favorites/{spot_id}` | Favorite spot | - | `{ok: true}` |
| DELETE | `/social/favorites/{spot_id}` | Remove favorite | - | `{ok: true}` |
| GET | `/social/favorites` | List my favorites | - | `List[SpotPublic]` |
| GET | `/social/users/{user_id}/favorites` | List user's favorites | - | `List[SpotPublic]` |
| GET | `/social/follow/requests` | Incoming follow requests | - | `List[FollowRequestPublic]` |
| POST | `/social/follow/requests/{follower_id}/approve` | Approve follow request | - | `{ok: true}` |
| POST | `/social/follow/requests/{follower_id}/reject` | Reject follow request | - | `{ok: true}` |
| POST | `/social/follow/{user_id}` | Follow user | - | `{ok, status}` |
| DELETE | `/social/follow/{user_id}` | Unfollow user | - | `{ok: true}` |
| GET | `/social/followers/{user_id}` | List followers | - | `List[UserPublic]` |
| GET | `/social/following/{user_id}` | List following | - | `List[UserPublic]` |
| DELETE | `/social/followers/{user_id}` | Remove follower | - | `{ok: true}` |
| POST | `/social/block/{user_id}` | Block user | - | `{ok: true}` |
| DELETE | `/social/block/{user_id}` | Unblock user | - | `{ok: true}` |
| GET | `/social/blocked` | List blocked users | - | `List[UserPublic]` |
| POST | `/social/share/{spot_id}` | Share spot | `ShareRequest` | `{ok: true}` |
| POST | `/social/support/tickets` | Create support ticket | `SupportTicketRequest` | `SupportTicketPublic` |
| GET | `/social/shared/{user_id}` | Shared spots list | - | `List[dict]` |

Endpoint evidence: `backend/routing/auth_routes.py:442`, `backend/routing/auth_routes.py:1004`

## 3) DTO Schemas (Current)

## Auth

- `RegisterRequest`
  - `username`, `email`, `password`, `display_name?`
  - Evidence: `backend/routing/auth_routes.py:80`

- `AuthTokenResponse`
  - `access_token`, `token_type`, `user`
  - Evidence: `backend/routing/auth_routes.py:167`

## User / Profile

- `UserPublic`
  - `id`, `username`, `email`, `display_name`, `bio`, `avatar_image`, `social_accounts`, `follow_requires_approval`, `created_at`
  - Evidence: `backend/routing/auth_routes.py:99`

- `UpdateProfileRequest`
  - profile fields + password change fields (`current_password`, `new_password`)
  - Evidence: `backend/routing/auth_routes.py:87`

## Spot

- `SpotUpsertRequest`
  - `title`, `description`, `tags`, `lat`, `lon`, `images`, `visibility`, `invite_user_ids`
  - Evidence: `backend/routing/auth_routes.py:111`

- `SpotPublic`
  - `id`, `owner_id`, `title`, `description`, `tags`, `lat`, `lon`, `images`, `visibility`, `invite_user_ids`, `created_at`
  - Evidence: `backend/routing/auth_routes.py:122`

## Support

- `SupportTicketRequest`
  - `category`, `subject`, `message`, `page`, `contact_email`, `allow_contact`
  - Evidence: `backend/routing/auth_routes.py:140`

- `SupportTicketPublic`
  - `id`, `user_id`, `category`, `subject`, `message`, `page`, `contact_email`, `allow_contact`, `status`, `created_at`
  - Evidence: `backend/routing/auth_routes.py:149`

## Generic error report payload

- `ClientErrorReport` for `/client-errors`
  - Evidence: `backend/data/dto.py:31`

## 4) Error Handling Contract

## Current state

- Generic CRUD router returns traceback-rich payload:
  - Evidence: `backend/routing/router.py:62`
- Auth/social routes raise plain string detail messages:
  - Evidence: `backend/routing/auth_routes.py:450`
- Frontend parser supports mixed payload styles:
  - Evidence: `webapp/src/services/apiErrors.js:49`, `webapp/src/services/apiErrors.js:155`

## Required unified error envelope

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Submitted data is invalid.",
    "details": [
      {"field": "email", "message": "Invalid email format"}
    ],
    "request_id": "req-20260216-abc123",
    "timestamp_utc": "2026-02-16T10:34:22Z"
  }
}
```

Rules:

- no traceback in client-facing payload
- stable machine-readable `code`
- optional `details[]`
- consistent status code semantics (`400`, `401`, `403`, `404`, `409`, `422`, `5xx`)

## 5) Client Communication Policy (Required)

- Add timeout with `AbortController` in `ApiClient.request`.
- Retry only idempotent GET requests on network/5xx (max 2 retries).
- Do not auto-retry POST/PUT/DELETE.
- Keep user-facing messages derived from structured error payload.

Current gap evidence: `webapp/src/services/apiClient.js:39`

## 6) Versioning / Backward Compatibility Policy

- Introduce `/api/v1` namespace for new/normalized contracts.
- Keep current unversioned paths as compatibility aliases temporarily.
- Mark deprecation in docs and remove after one release cycle.

## 7) Rate-Limiting Strategy

- Application-level limiting is intentionally kept simple in the backend app layer.
- Production rate limiting is enforced at the edge/proxy layer (for example Nginx/API gateway/WAF).
- Suggested baseline:
  - `/auth/login`, `/auth/register`: strict burst + minute limits
  - `/social/support/tickets`: medium write throttling
  - read endpoints: softer limits with higher burst allowance
- This keeps throttling centralized and deployment-specific without coupling business logic to one runtime.

## 8) Short Request Examples

## Register

`POST /auth/register`

```json
{
  "username": "maxmustermann",
  "email": "max@example.com",
  "password": "Abcd1234!",
  "display_name": "Max"
}
```

## Create Spot

`POST /social/spots`

```json
{
  "title": "Lake viewpoint",
  "description": "Quiet sunrise spot",
  "tags": ["nature", "sunrise"],
  "lat": 47.3769,
  "lon": 8.5417,
  "images": [],
  "visibility": "public",
  "invite_user_ids": []
}
```
